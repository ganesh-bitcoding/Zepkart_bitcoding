{% extends "../base.html" %}
{% block start %}
    <div class="registration-form">
      <form method="post" id="registration-form">
        {% csrf_token %}
        <div class="form-icon">
          <span><i class="icon icon-user"></i></span>
        </div>
        <div class="form-group">
          <input
            type="text"
            class="form-control item"
            id="username"
            placeholder="Username or Email id"
          />
        </div>
        <div class="form-group" id="messageUser"></div>
        <div class="form-group">
          <input
            type="password"
            class="form-control item"
            id="password"
            placeholder="Password"
          />
        </div>
        <div class="form-group" id="messagePass"></div>
        <div class="form-group" id="message"></div>
        <div class="form-group">
          <input
            type="submit"
            class="btn btn-block create-account"
            value="Login to My Account"
          />
        </div>
      </form>
    </div>
  
    <!-- <script src="assets/js/script.js"></script> -->
    <script>
      document
        .querySelector("#registration-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          let message = document.getElementById("message");
          let messageUser = document.getElementById("messageUser");
          let messagePass = document.getElementById("messagePass");
          let Username = document.getElementById("username").value;
          let Password = document.getElementById("password").value;
          let csrftoken = document.querySelector(
            "[name=csrfmiddlewaretoken]"
          ).value;

          messageUser.innerHTML = "";
          messagePass.innerHTML = "";
          message.innerHTML = "";
          if (!Username) {
            messageUser.innerHTML =
              '<div class="alert alert-danger">Username Cannot be Empty</div>';
          }
          if (!Password) {
            messagePass.innerHTML =
              '<div class="alert alert-danger"> Password Cannot be Empty</div>';
          }

          if (Username && Password) {
            data = {
              Username: Username,
              Password: Password,
            };
            fetch("/accounts/login/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken,
              },
              body: JSON.stringify(data),
            })
              .then((res) => {
                if (!res.ok) {
                  return res.json().then((text) => {
                    throw text;
                  });
                }
                return res.json();
              })
              .then((result) => {
                message.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                if (result.redirect_url) {
                  window.location.href = result.redirect_url; 
                }
              })
              .catch((err) => {
                message.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
              });
          }
        });
    </script>

{% endblock  %}